
CREATE TABLE public.users (
  id				INT generated by default AS IDENTITY primary key,
  login			VARCHAR(15)  NOT NULL,
  password	VARCHAR(100) NOT NULL,
  email			VARCHAR(30)  NOT NULL,
  CONSTRAINT users_mail_un UNIQUE (email),
  CONSTRAINT users_un UNIQUE (login)
);

CREATE TABLE public.cities (
  id				INT generated by default AS IDENTITY primary key,
  name			VARCHAR(15) NOT NULL,
  x       	INT        NOT NULL,
  y       	INT        NOT NULL,
  points  	INT        NOT NULL DEFAULT 3,
  user_id 	INT        NULL,
  CONSTRAINT user_fk FOREIGN KEY (user_id) REFERENCES public.users (id) ON DELETE SET NULL
);

CREATE TABLE public.constructions (
  id           INT generated by default AS IDENTITY primary key,
  city_id      INT NOT NULL,
  level				 INT NOT NULL DEFAULT 1,
  x            INT NOT NULL,
  y            INT NOT NULL,
  build_type   INT NOT NULL,
  need_refresh BOOL NOT NULL DEFAULT TRUE,
  CONSTRAINT city_fk FOREIGN KEY (city_id) REFERENCES public.cities (id) ON DELETE CASCADE
);

CREATE TABLE public.military (
  id        	INT generated by default AS IDENTITY primary key,
  city_from 	INT NOT NULL,
  city_to   	INT NULL,
  type    		INT NOT NULL,
  troops    	JSON NOT NULL,
  CONSTRAINT city_from_fk FOREIGN KEY (city_from) REFERENCES public.cities (id) ON DELETE CASCADE,
  CONSTRAINT city_to_fk FOREIGN KEY (city_to) REFERENCES public.cities (id) ON DELETE SET NULL
);


CREATE TABLE public.reports (
  id      	INT generated by default AS IDENTITY primary key,
  readers 	INT [] NOT NULL,
  city_id 	INT    NOT NULL,
  info    	JSON    NOT NULL,
  CONSTRAINT city_fk FOREIGN KEY (city_id) REFERENCES public.cities (id) ON DELETE CASCADE
);


CREATE TABLE public.upgrades (
  id              INT generated by default AS IDENTITY primary key,
  construction_id INT      NOT NULL,
  city_id         INT      NOT NULL,
  completion      TIMESTAMP NOT NULL,
  CONSTRAINT city_fk FOREIGN KEY (city_id) REFERENCES public.cities (id),
  CONSTRAINT construction_fk FOREIGN KEY (construction_id) REFERENCES public.constructions (id) ON DELETE CASCADE
);

CREATE TABLE public.sessions (
  "key"   VARCHAR(64) NOT NULL,
  user_id INT        NOT NULL,
  ip      INET        NOT NULL,
  CONSTRAINT sessions_pk PRIMARY KEY ("key")
);

CREATE UNIQUE INDEX sessions_key_idx ON public.sessions ("key" text_ops);

CREATE UNIQUE INDEX cities_id_uindex ON public.cities (id int4_ops);

CREATE INDEX cities_user_index ON public.cities (user_id int4_ops);

CREATE UNIQUE INDEX users_email_idx ON public.users (email text_ops);

CREATE UNIQUE INDEX users_id_uindex ON public.users (id int4_ops);

CREATE UNIQUE INDEX users_login_uindex ON public.users (login text_ops);

CREATE UNIQUE INDEX upgrades_id_uindex ON public.upgrades (id int4_ops);

CREATE INDEX constructions_city_id_index ON public.constructions (city_id int4_ops);

CREATE UNIQUE INDEX constructions_id_uindex ON public.constructions (id int4_ops);

CREATE UNIQUE INDEX military_id_uindex ON public.military (id int4_ops);

CREATE UNIQUE INDEX reports_id_uindex ON public.reports (id int4_ops);